# forge-dev Usage Guide

## Purpose

`forge-dev` is a code generation build engine that generates typed Spec structs, validation code, and MCP boilerplate from OpenAPI specifications. It enables consistent, type-safe configuration handling across all forge engines.

## Overview

forge-dev reads two configuration files from an engine directory:

1. **forge-dev.yaml** - Engine metadata and code generation settings
2. **spec.openapi.yaml** - OpenAPI 3.0 schema defining the engine's Spec structure

It generates three Go files:

- **zz_generated.spec.go** - Typed Spec struct with JSON tags and conversion functions
- **zz_generated.validate.go** - Validation functions for Spec
- **zz_generated.mcp.go** - MCP server setup boilerplate

## Invocation

### MCP Mode (Primary)

Run as an MCP server (typical usage via forge):

```bash
forge-dev --mcp
```

Forge invokes this automatically when using:

```yaml
engine: go://forge-dev
```

### CLI Mode

CLI mode is not currently supported. forge-dev is primarily designed to run as an MCP server.

## Available MCP Tools

### `build`

Generate code for a single engine.

**Input Schema:**
```json
{
  "name": "string (required)",
  "src": "string (required - path to engine directory)",
  "engine": "string (optional)"
}
```

**Output:**
```json
{
  "name": "string",
  "type": "generated",
  "location": "string (path to output directory)",
  "timestamp": "string",
  "version": "string (sha256 checksum)"
}
```

### `buildBatch`

Generate code for multiple engines in batch.

**Input Schema:**
```json
{
  "specs": [
    {
      "name": "string",
      "src": "string",
      "engine": "string"
    }
  ]
}
```

### `config-validate`

Validate forge-dev configuration files.

**Input Schema:**
```json
{
  "spec": {
    "configPath": "string (path to engine directory)"
  }
}
```

**Output:**
```json
{
  "valid": true,
  "errors": [],
  "warnings": []
}
```

### `docs-list`

List available documentation for forge-dev.

### `docs-get`

Get specific documentation by name.

## Common Use Cases

### Adding forge-dev Support to an Engine

1. Create `forge-dev.yaml` in your engine directory:

```yaml
name: my-engine
type: builder        # or: test-runner, testenv-subengine
version: 0.15.0
description: My custom build engine
openapi:
  specPath: ./spec.openapi.yaml
generate:
  packageName: main
```

2. Create `spec.openapi.yaml` defining your Spec schema:

```yaml
openapi: 3.0.3
info:
  title: my-engine Spec Schema
  version: 0.15.0
components:
  schemas:
    Spec:
      type: object
      properties:
        outputDir:
          type: string
          description: Output directory for generated files
        verbose:
          type: boolean
          description: Enable verbose output
        tags:
          type: array
          items:
            type: string
          description: Build tags to include
      required:
        - outputDir
```

3. Add forge-dev generation to forge.yaml:

```yaml
build:
  - name: generate-my-engine
    src: ./cmd/my-engine
    engine: go://forge-dev

  - name: my-engine
    src: ./cmd/my-engine
    dest: ./build/bin
    engine: go://go-build
    depends: [generate-my-engine]
```

4. Run generation:

```bash
forge build generate-my-engine
```

### Using Generated Code in Your Engine

After generation, use the SetupMCPServer function in your mcp.go:

```go
// For builder engines:
func runMCPServer() error {
    server, err := SetupMCPServer(Version, myBuildFunc)
    if err != nil {
        return err
    }
    return server.RunDefault()
}

func myBuildFunc(ctx context.Context, input mcptypes.BuildInput, spec *Spec) (*forge.Artifact, error) {
    // spec is already parsed and validated
    // Use spec.OutputDir, spec.Verbose, etc.
    return &forge.Artifact{...}, nil
}
```

## Implementation Details

- Uses SHA256 checksums for idempotent generation (skips if sources unchanged)
- Embeds templates via go:embed for single-binary distribution
- Generates gofmt-formatted code
- Supports three engine types: builder, test-runner, testenv-subengine

## Checksum-Based Regeneration

forge-dev computes a checksum of forge-dev.yaml and spec.openapi.yaml combined. Generated files include this checksum in a header comment:

```go
// Code generated by forge-dev. DO NOT EDIT.
// Source: spec.openapi.yaml
// SourceChecksum: sha256:abc123...
```

If the checksum matches, generation is skipped, making builds idempotent.

## Supported OpenAPI Types

| OpenAPI Type | Go Type |
|--------------|---------|
| `string` | `string` |
| `boolean` | `bool` |
| `integer` | `int` |
| `number` | `float64` |
| `array` of strings | `[]string` |
| `array` of integers | `[]int` |
| `object` with `additionalProperties` | `map[string]T` |
| `string` with `enum` | `string` (with validation) |

### Limitations (v1)

- Arrays of objects are NOT supported
- `$ref` references are NOT supported
- `oneOf`, `anyOf`, `allOf` are NOT supported

## See Also

- [forge-dev Configuration Schema](schema.md)
- [ARCHITECTURE.md](../../../ARCHITECTURE.md)
