name: forge

# -- envFile is the path to a global environment file to source before any operations
envFile: .envrc

# -- artifactStorePath is the path to the unified artifact store (moved to root level)
artifactStorePath: .forge/artifact-store.yaml

# -- localContainerRegistry configuration (root level defaults)
localContainerRegistry:
  enabled: false  # Disabled by default, enabled via testenv spec
  namespace: testenv-lcr
  credentialPath: .forge/registry-credentials.yaml
  caCrtPath: .forge/ca.crt

# -- engines defines custom engine configurations with aliases
#
# Parallel Engines Documentation:
#
# go://parallel-builder - Runs multiple builders in parallel
# Example usage in build section:
#   - name: all-binaries
#     engine: go://parallel-builder
#     spec:
#       builders:
#         - name: forge-cli
#           engine: go://go-build
#           spec:
#             src: ./cmd/forge
#             dest: ./build/bin
#         - name: go-test-runner
#           engine: go://go-build
#           spec:
#             src: ./cmd/go-test
#             dest: ./build/bin
#
# go://parallel-test-runner - Runs multiple test runners in parallel
# Example usage in test section:
#   - name: unit-and-lint
#     runner: go://parallel-test-runner
#     spec:
#       primaryCoverageRunner: go-test  # Coverage is taken from this runner only
#       runners:
#         - name: go-test
#           engine: go://go-test
#           spec:
#             packages: ./pkg/...
#         - name: go-lint-licenses
#           engine: go://go-lint-licenses
#           spec: {}
#
# Key notes:
# - All sub-engines must use go:// URIs (not alias://)
# - Coverage is NOT averaged - it comes from primaryCoverageRunner only
# - TestStats are summed from all runners
# - If any runner fails, the overall status is "failed"
# - All results are collected (no fail-fast behavior)
#
engines:
  # Example: custom test runner alias
  # - alias: verify-tags-runner
  #   type: test-runner
  #   testRunner:
  #     - engine: go://generic-test-runner
  #       spec:
  #         command: "go"
  #         args: ["run", "./cmd/go-lint-tags", "."]

  # Fast stub testenv for e2e testing (no real resources created)
  - alias: setup-e2e-stub
    type: testenv
    testenv:
      - engine: "go://testenv-stub"

  - alias: setup-integration
    type: testenv
    testenv:
      - engine: "go://testenv-kind"
      # spec:
      #   kubeconfigPath: .ignore.kindenv.kubeconfig.yaml
      #
      #   # -- envPropagation controls environment variable propagation (optional)
      #   # Environment variables are propagated automatically by default
      #   # envPropagation:
      #     # disabled: false           # Default: false (propagation enabled)
      #     # priority: 0               # Default: 65536 (lower number = higher priority)
      #     # whitelist: []             # Default: [] (all vars pass, mutually exclusive with blacklist)
      #     # blacklist: []             # Default: [] (all vars pass, mutually exclusive with whitelist)
      #     # envs:                     # Per-environment variable priority overrides
      #     #   KUBECONFIG:
      #     #     priority: 0           # Override priority for specific variable

      - # -- localContainerRegistry will create if enabled a container registry in the kindenv using the kubeconfig which path
        #    is defined by {.kindenv.kubeconfigPath}.
        engine: "go://testenv-lcr"
        spec:
          # -- enabled defines whether the local container registry must be created or not.
          enabled: true
          # -- images defines the list of images to push to the local container registry.
          # Use local:// prefix for locally built images (e.g., local://myapp:v1.0.0)
          # Use full registry path for remote images (e.g., quay.io/example/img:v1)
          images:
            # Minimal test image built by forge - much faster than pulling from remote
            - name: local://for-testing-purposes:latest
          # -- creadentialPath defines the output file containing the container registry credentials.
          # credentialPath: .ignore.local-container-registry.yaml
          # -- path to CA certificate.
          # caCrtPath: .ignore.ca.crt
          # -- namespace where the local container registry will be deployed.
          # namespace: local-container-registry
          # -- imagePullSecretNamespaces is a list of namespaces where image pull secrets should be automatically created.
          imagePullSecretNamespaces:
            - default
            - test-podinfo
            # -- imagePullSecretName is the name of the image pull secret to create (defaults to "local-container-registry-credentials").
            # imagePullSecretName: local-container-registry-credentials
          #
          # -- Example: Environment propagation with security filtering
          # envPropagation:
          #   blacklist:
          #     - REGISTRY_PASSWORD    # Don't propagate sensitive credentials
          #     - SECRET_TOKEN

      - # -- testenv-helm-install installs Helm charts into the Kind cluster
        engine: "go://testenv-helm-install"
        spec:
          charts:
            # FluxCD-inspired comprehensive spec
            - name: podinfo-release
              sourceType: helm-repo
              url: https://stefanprodan.github.io/podinfo
              chartName: podinfo
              # version: "6.0.0"  # Optional: specify exact version
              namespace: test-podinfo
              releaseName: test-podinfo
              createNamespace: true
              timeout: "5m"
              disableWait: false
              # Optional lifecycle fields:
              # forceUpgrade: false
              # disableHooks: false
              # testEnable: false
              # values:
              #   replicaCount: 2
              #   service:
              #     type: ClusterIP
              # valuesFiles:
              #   - ./custom-values.yaml

          # -- Example: Template expansion using environment variables from previous sub-engines
          # kubeconfigPath: "{{.Env.KUBECONFIG}}"  # Reference KUBECONFIG from testenv-kind
          # charts:
          #   - name: my-app
          #     values:
          #       registry: "{{.Env.TESTENV_LCR_FQDN}}"  # Reference registry FQDN from testenv-lcr

# -- test defines the test stages and their configuration
test:
  # -- lint-tags - verify all test files have build tags
  - name: lint-tags
    runner: "go://go-lint-tags"
    # -- default value for setup is "go://test-report"

  # -- lint-license - verify all Go files have license headers
  - name: lint-license
    runner: "go://go-lint-licenses"

  # -- lint - linting as a test stage (no environment needed)
  - name: lint
    runner: "go://go-lint"

  # -- unit tests - no environment management needed
  - name: unit
    runner: "go://go-test"

  # -- integration tests - creates isolated test environments
  - name: integration
    runner: "go://go-test"
    testenv: "alias://setup-integration"
    # spec:
    #   # -- Example: Test runner environment filtering (optional)
    #   # Control which environment variables from testenv are passed to tests
    #   # envPropagation:
    #     # whitelist:                # Only propagate these variables
    #     #   - KUBECONFIG
    #     #   - TESTENV_LCR_FQDN
    #     # blacklist:                # Propagate all except these (mutually exclusive with whitelist)
    #     #   - REGISTRY_PASSWORD
    #     #   - SECRET_TOKEN
    #     # disabled: false           # Set to true to disable all environment propagation to tests

  # -- e2e tests - comprehensive forge integration tests (no environment needed)
  - name: e2e
    runner: "go://forge-e2e"

  # -- e2e-stub - lightweight testenv for fast e2e testing of create/list/get/delete workflow
  - name: e2e-stub
    runner: "go://go-test"
    testenv: "alias://setup-e2e-stub"

# -- build defines the artifacts to build
build:
  # Format code before building
  - name: format-code
    src: .
    engine: go://go-format

  # Binaries
  - name: forge
    src: ./cmd/forge
    dest: ./build/bin
    engine: go://go-build
  - name: go-build
    src: ./cmd/go-build
    dest: ./build/bin
    engine: go://go-build
  - name: container-build
    src: ./cmd/container-build
    dest: ./build/bin
    engine: go://go-build
  - name: testenv-kind
    src: ./cmd/testenv-kind
    dest: ./build/bin
    engine: go://go-build
  - name: testenv-lcr
    src: ./cmd/testenv-lcr
    dest: ./build/bin
    engine: go://go-build
  - name: testenv-helm-install
    src: ./cmd/testenv-helm-install
    dest: ./build/bin
    engine: go://go-build
  - name: testenv-stub
    src: ./cmd/testenv-stub
    dest: ./build/bin
    engine: go://go-build
  - name: go-test
    src: ./cmd/go-test
    dest: ./build/bin
    engine: go://go-build
  - name: go-lint-licenses
    src: ./cmd/go-lint-licenses
    dest: ./build/bin
    engine: go://go-build
  - name: go-lint-tags
    src: ./cmd/go-lint-tags
    dest: ./build/bin
    engine: go://go-build
  - name: testenv
    src: ./cmd/testenv
    dest: ./build/bin
    engine: go://go-build
  - name: go-format
    src: ./cmd/go-format
    dest: ./build/bin
    engine: go://go-build
  - name: go-lint
    src: ./cmd/go-lint
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-mocks
    src: ./cmd/go-gen-mocks
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-openapi
    src: ./cmd/go-gen-openapi
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-protobuf
    src: ./cmd/go-gen-protobuf
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-bpf
    src: ./cmd/go-gen-bpf
    dest: ./build/bin
    engine: go://go-build
  - name: forge-e2e
    src: ./cmd/forge-e2e
    dest: ./build/bin
    engine: go://go-build
  - name: generic-builder
    src: ./cmd/generic-builder
    dest: ./build/bin
    engine: go://go-build
  - name: generic-test-runner
    src: ./cmd/generic-test-runner
    dest: ./build/bin
    engine: go://go-build
  - name: parallel-builder
    src: ./cmd/parallel-builder
    dest: ./build/bin
    engine: go://go-build
  - name: parallel-test-runner
    src: ./cmd/parallel-test-runner
    dest: ./build/bin
    engine: go://go-build
  - name: test-report
    src: ./cmd/test-report
    dest: ./build/bin
    engine: go://go-build
  - name: ci-orchestrator
    src: ./cmd/ci-orchestrator
    dest: ./build/bin
    engine: go://go-build
  - name: go-dependency-detector
    src: ./cmd/go-dependency-detector
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-mocks-dep-detector
    src: ./cmd/go-gen-mocks-dep-detector
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-openapi-dep-detector
    src: ./cmd/go-gen-openapi-dep-detector
    dest: ./build/bin
    engine: go://go-build
  - name: forge-dev
    src: ./cmd/forge-dev
    dest: ./build/bin
    engine: go://go-build
    spec:
      ldflags: "-X main.Version={{.GitVersion}}"

  # Mock generation
  - name: generated-mocks
    src: .
    dest: ./internal/util/mocks
    engine: go://go-gen-mocks

  # Code generation (forge-dev)
  - name: gen-container-build
    src: ./cmd/container-build
    engine: go://forge-dev
  - name: gen-forge-e2e
    src: ./cmd/forge-e2e
    engine: go://forge-dev
  - name: gen-generic-builder
    src: ./cmd/generic-builder
    engine: go://forge-dev
  - name: gen-generic-test-runner
    src: ./cmd/generic-test-runner
    engine: go://forge-dev
  - name: gen-go-build
    src: ./cmd/go-build
    engine: go://forge-dev
  - name: gen-go-dependency-detector
    src: ./cmd/go-dependency-detector
    engine: go://forge-dev
  - name: gen-go-format
    src: ./cmd/go-format
    engine: go://forge-dev
  - name: gen-go-gen-bpf
    src: ./cmd/go-gen-bpf
    engine: go://forge-dev
  - name: gen-go-gen-mocks
    src: ./cmd/go-gen-mocks
    engine: go://forge-dev
  - name: gen-go-gen-mocks-dep-detector
    src: ./cmd/go-gen-mocks-dep-detector
    engine: go://forge-dev
  - name: gen-go-gen-openapi
    src: ./cmd/go-gen-openapi
    engine: go://forge-dev
  - name: gen-go-gen-openapi-dep-detector
    src: ./cmd/go-gen-openapi-dep-detector
    engine: go://forge-dev
  - name: gen-go-gen-protobuf
    src: ./cmd/go-gen-protobuf
    engine: go://forge-dev
  - name: gen-go-lint
    src: ./cmd/go-lint
    engine: go://forge-dev
  - name: gen-go-lint-licenses
    src: ./cmd/go-lint-licenses
    engine: go://forge-dev
  - name: gen-go-lint-tags
    src: ./cmd/go-lint-tags
    engine: go://forge-dev
  - name: gen-go-test
    src: ./cmd/go-test
    engine: go://forge-dev
  - name: gen-parallel-builder
    src: ./cmd/parallel-builder
    engine: go://forge-dev
  - name: gen-parallel-test-runner
    src: ./cmd/parallel-test-runner
    engine: go://forge-dev
  - name: gen-testenv-helm-install
    src: ./cmd/testenv-helm-install
    engine: go://forge-dev
  - name: gen-testenv-kind
    src: ./cmd/testenv-kind
    engine: go://forge-dev
  - name: gen-testenv-lcr
    src: ./cmd/testenv-lcr
    engine: go://forge-dev

  # Containers
  - name: for-testing-purposes
    src: ./containers/for-testing-purposes/Containerfile
    engine: go://container-build

# Example: OpenAPI code generation
# Generates client and/or server code from OpenAPI specifications
# NOTE: Uncomment and customize for your API specs
#
# - name: example-api-v1
#   src: ./api/example-api.v1.yaml      # Required by BuildSpec (source file)
#   dest: ./pkg/generated                # Required by BuildSpec (destination directory)
#   engine: go://go-gen-openapi
#   spec:
#     # Option 1: Explicit source file (RECOMMENDED)
#     sourceFile: ./api/example-api.v1.yaml
#
#     # Option 2: Templated source file (uncomment if not using sourceFile)
#     # sourceDir: ./api
#     # name: example-api
#     # version: v1
#     # Results in: ./api/example-api.v1.yaml
#
#     # Output directory (defaults to ./pkg/generated if not specified)
#     destinationDir: ./pkg/generated
#
#     # Client generation
#     client:
#       enabled: true
#       packageName: exampleclient
#
#     # Server generation (optional, can generate both client and server in one BuildSpec)
#     server:
#       enabled: false
#       packageName: exampleserver

